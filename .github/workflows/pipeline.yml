name: CI/CD Pipeline

on:
  push:
    branches:
      - maind

jobs:
# ----------------------------------
# 1️⃣ Detect Changes
# ----------------------------------
  detect-changes:
    name: Detect Changes
    runs-on: self-hosted
    outputs:
      frontend: ${{ steps.frontend.outputs.changed }}
      backend: ${{ steps.backend.outputs.changed }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect Frontend Changes
        id: frontend
        run: |
          git diff --name-only HEAD~1 HEAD | grep '^frontend/' \
            && echo "changed=true" >> $GITHUB_OUTPUT \
            || echo "changed=false" >> $GITHUB_OUTPUT

      - name: Detect Backend Changes
        id: backend
        run: |
          git diff --name-only HEAD~1 HEAD | grep '^backend/' \
            && echo "changed=true" >> $GITHUB_OUTPUT \
            || echo "changed=false" >> $GITHUB_OUTPUT

# ----------------------------------
# 2️⃣ Build Frontend
# ----------------------------------
  build-frontend:
    name: Build Frontend
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    outputs:
      tag: ${{ steps.build.outputs.tag }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: SonarQube Scan Frontend
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          docker run --rm \
            -e SONAR_HOST_URL=$SONAR_HOST_URL \
            -e SONAR_TOKEN=$SONAR_TOKEN \
            -v "$PWD/frontend:/usr/src" \
            sonarsource/sonar-scanner-cli:latest \
            -Dsonar.projectKey=frontend \
            -Dsonar.sources=. \
            -Dsonar.sourceEncoding=UTF-8

      - name: Build Frontend Image
        id: build
        run: |
          LATEST_TAG=$(curl -s https://hub.docker.com/v2/repositories/abidhurais/helm-manifest-frontend/tags?page_size=100 \
            | jq -r '.results[]?.name' | grep -E '^[0-9]+\.0$' | sort -V | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            VERSION="1.0"
          else
            MAJOR=$(echo $LATEST_TAG | cut -d'.' -f1)
            VERSION="$((MAJOR + 1)).0"
          fi

          echo "tag=$VERSION" >> $GITHUB_OUTPUT

          docker build \
            -t abidhurais/helm-manifest-frontend:$VERSION \
            -t abidhurais/helm-manifest-frontend:latest \
            frontend

      - name: Trivy Scan Frontend Image
        run: |
          trivy image --severity HIGH,CRITICAL \
            abidhurais/helm-manifest-frontend:latest

      - name: Push Frontend Image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          docker push abidhurais/helm-manifest-frontend:${{ steps.build.outputs.tag }}
          docker push abidhurais/helm-manifest-frontend:latest

# ----------------------------------
# 3️⃣ Deploy Frontend
# ----------------------------------
  deploy-frontend:
    name: Deploy Frontend
    runs-on: self-hosted
    needs: build-frontend
    steps:
      - name: Deploy Frontend to Kubernetes
        run: |
          helm upgrade --install myapp helm/myapp -n devops-app

# ----------------------------------
# 4️⃣ Build Backend
# ----------------------------------
  build-backend:
    name: Build Backend
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    outputs:
      tag: ${{ steps.build.outputs.tag }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: SonarQube Scan Backend
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          docker run --rm \
            -e SONAR_HOST_URL=$SONAR_HOST_URL \
            -e SONAR_TOKEN=$SONAR_TOKEN \
            -v "$PWD/backend:/usr/src" \
            sonarsource/sonar-scanner-cli:latest \
            -Dsonar.projectKey=backend \
            -Dsonar.sources=. \
            -Dsonar.sourceEncoding=UTF-8

      - name: Build Backend Image
        id: build
        run: |
          LATEST_TAG=$(curl -s https://hub.docker.com/v2/repositories/abidhurais/helm-manifest-backend/tags?page_size=100 \
            | jq -r '.results[]?.name' | grep -E '^[0-9]+\.0$' | sort -V | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            VERSION="1.0"
          else
            MAJOR=$(echo $LATEST_TAG | cut -d'.' -f1)
            VERSION="$((MAJOR + 1)).0"
          fi

          echo "tag=$VERSION" >> $GITHUB_OUTPUT

          docker build --network=host \
            -t abidhurais/helm-manifest-backend:$VERSION \
            -t abidhurais/helm-manifest-backend:latest \
            backend

      - name: Trivy Scan Backend Image
        run: |
          trivy image --severity HIGH,CRITICAL \
            abidhurais/helm-manifest-backend:latest

      - name: Push Backend Image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          docker push abidhurais/helm-manifest-backend:${{ steps.build.outputs.tag }}
          docker push abidhurais/helm-manifest-backend:latest

# ----------------------------------
# 5️⃣ Deploy Backend
# ----------------------------------
  deploy-backend:
    name: Deploy Backend
    runs-on: self-hosted
    needs: build-backend
    steps:
      - name: Deploy Backend to Kubernetes
        run: |
          helm upgrade --install myapp helm/myapp -n devops-app
