name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
# ----------------------------------
# 1️⃣ Detect Changes
# ----------------------------------
  detect-changes:
    name: Detect Changes
    runs-on: self-hosted
    outputs:
      frontend: ${{ steps.frontend.outputs.changed }}
      backend: ${{ steps.backend.outputs.changed }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect Frontend Changes
        id: frontend
        run: |
          git diff --name-only HEAD~1 HEAD | grep '^frontend/' \
            && echo "changed=true" >> $GITHUB_OUTPUT \
            || echo "changed=false" >> $GITHUB_OUTPUT

      - name: Detect Backend Changes
        id: backend
        run: |
          git diff --name-only HEAD~1 HEAD | grep '^backend/' \
            && echo "changed=true" >> $GITHUB_OUTPUT \
            || echo "changed=false" >> $GITHUB_OUTPUT

# ----------------------------------
# 2️⃣ Frontend Pipeline
# ----------------------------------
  frontend:
    name: Build & Deploy Frontend
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Build Frontend Image
        id: fe-build
        run: |
          LATEST_TAG=$(curl -s https://hub.docker.com/v2/repositories/abidhurais/helm-manifest-frontend/tags?page_size=100 \
            | jq -r '.results[]?.name' | grep -E '^[0-9]+\.0$' | sort -V | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            VERSION="1.0"
          else
            MAJOR=$(echo $LATEST_TAG | cut -d'.' -f1)
            VERSION="$((MAJOR + 1)).0"
          fi

          echo "tag=$VERSION" >> $GITHUB_OUTPUT

          docker build \
            -t abidhurais/helm-manifest-frontend:$VERSION \
            -t abidhurais/helm-manifest-frontend:latest \
            frontend

      - name: Trivy Scan Frontend Image
        run: |
          trivy image --severity HIGH,CRITICAL \
            abidhurais/helm-manifest-frontend:latest

      - name: Push Frontend Image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          docker push abidhurais/helm-manifest-frontend:${{ steps.fe-build.outputs.tag }}
          docker push abidhurais/helm-manifest-frontend:latest

      - name: Deploy Frontend to Kubernetes
        run: |
          helm upgrade --install myapp helm/myapp -n devops-app

# ----------------------------------
# 3️⃣ Backend Pipeline
# ----------------------------------
  backend:
    name: Build & Deploy Backend
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Build Backend Image
        id: be-build
        run: |
          LATEST_TAG=$(curl -s https://hub.docker.com/v2/repositories/abidhurais/helm-manifest-backend/tags?page_size=100 \
            | jq -r '.results[]?.name' | grep -E '^[0-9]+\.0$' | sort -V | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            VERSION="1.0"
          else
            MAJOR=$(echo $LATEST_TAG | cut -d'.' -f1)
            VERSION="$((MAJOR + 1)).0"
          fi

          echo "tag=$VERSION" >> $GITHUB_OUTPUT

          docker build --network=host \
            -t abidhurais/helm-manifest-backend:$VERSION \
            -t abidhurais/helm-manifest-backend:latest \
            backend

      - name: Trivy Scan Backend Image
        run: |
          trivy image --severity HIGH,CRITICAL \
            abidhurais/helm-manifest-backend:latest

      - name: Push Backend Image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          docker push abidhurais/helm-manifest-backend:${{ steps.be-build.outputs.tag }}
          docker push abidhurais/helm-manifest-backend:latest

      - name: Deploy Backend to Kubernetes
        run: |
          helm upgrade --install myapp helm/myapp -n devops-app
