name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
# ----------------------------------
# 1️⃣ Detect Changes
# ----------------------------------
  detect-changes:
    name: Detect Changes
    runs-on: self-hosted
    outputs:
      frontend: ${{ steps.frontend.outputs.changed }}
      backend: ${{ steps.backend.outputs.changed }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect Frontend Changes
        id: frontend
        run: |
          git diff --name-only HEAD~1 HEAD | grep '^frontend/' \
            && echo "changed=true" >> $GITHUB_OUTPUT \
            || echo "changed=false" >> $GITHUB_OUTPUT

      - name: Detect Backend Changes
        id: backend
        run: |
          git diff --name-only HEAD~1 HEAD | grep '^backend/' \
            && echo "changed=true" >> $GITHUB_OUTPUT \
            || echo "changed=false" >> $GITHUB_OUTPUT

# ----------------------------------
# 2️⃣ Build Frontend
# ----------------------------------
  build-frontend:
    name: Build Frontend
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    outputs:
      tag: ${{ steps.build.outputs.tag }}
    steps:
      - uses: actions/checkout@v3

      - name: Build Frontend Image
        id: build
        run: |
          LATEST_TAG=$(curl -s https://hub.docker.com/v2/repositories/abidhurais/helm-manifest-frontend/tags?page_size=100 \
            | jq -r '.results[]?.name' | grep -E '^[0-9]+\.0$' | sort -V | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            VERSION="1.0"
          else
            MAJOR=$(echo $LATEST_TAG | cut -d'.' -f1)
            VERSION="$((MAJOR + 1)).0"
          fi

          echo "tag=$VERSION" >> $GITHUB_OUTPUT

          docker build \
            -t abidhurais/helm-manifest-frontend:$VERSION \
            -t abidhurais/helm-manifest-frontend:latest \
            frontend

# ----------------------------------
# 3️⃣ SonarQube Frontend
# ----------------------------------
  sonar-frontend:
    name: SonarQube Frontend Scan
    runs-on: self-hosted
    needs: build-frontend
    steps:
      - uses: actions/checkout@v3

      - name: Run SonarQube Scan (Frontend)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=frontend \
            -Dsonar.sources=frontend \
            -Dsonar.host.url=http://sonarqube:9000 \
            -Dsonar.login=$SONAR_TOKEN

# ----------------------------------
# 4️⃣ Trivy + Push Frontend
# ----------------------------------
  push-frontend:
    name: Push Frontend Image
    runs-on: self-hosted
    needs: sonar-frontend
    steps:
      - name: Trivy Scan Frontend Image
        run: |
          trivy image --severity HIGH,CRITICAL \
            abidhurais/helm-manifest-frontend:latest

      - name: Push Frontend Image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          docker push abidhurais/helm-manifest-frontend:latest

# ----------------------------------
# 5️⃣ Deploy Frontend
# ----------------------------------
  deploy-frontend:
    name: Deploy Frontend
    runs-on: self-hosted
    needs: push-frontend
    steps:
      - run: helm upgrade --install myapp helm/myapp -n devops-app

# ----------------------------------
# 6️⃣ Build Backend
# ----------------------------------
  build-backend:
    name: Build Backend
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    outputs:
      tag: ${{ steps.build.outputs.tag }}
    steps:
      - uses: actions/checkout@v3

      - name: Build Backend Image
        id: build
        run: |
          LATEST_TAG=$(curl -s https://hub.docker.com/v2/repositories/abidhurais/helm-manifest-backend/tags?page_size=100 \
            | jq -r '.results[]?.name' | grep -E '^[0-9]+\.0$' | sort -V | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            VERSION="1.0"
          else
            MAJOR=$(echo $LATEST_TAG | cut -d'.' -f1)
            VERSION="$((MAJOR + 1)).0"
          fi

          echo "tag=$VERSION" >> $GITHUB_OUTPUT

          docker build --network=host \
            -t abidhurais/helm-manifest-backend:$VERSION \
            -t abidhurais/helm-manifest-backend:latest \
            backend

# ----------------------------------
# 7️⃣ SonarQube Backend
# ----------------------------------
  sonar-backend:
    name: SonarQube Backend Scan
    runs-on: self-hosted
    needs: build-backend
    steps:
      - uses: actions/checkout@v3

      - name: Run SonarQube Scan (Backend)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=backend \
            -Dsonar.sources=backend \
            -Dsonar.host.url=http://sonarqube:9000 \
            -Dsonar.login=$SONAR_TOKEN

# ----------------------------------
# 8️⃣ Trivy + Push Backend
# ----------------------------------
  push-backend:
    name: Push Backend Image
    runs-on: self-hosted
    needs: sonar-backend
    steps:
      - name: Trivy Scan Backend Image
        run: |
          trivy image --severity HIGH,CRITICAL \
            abidhurais/helm-manifest-backend:latest

      - name: Push Backend Image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          docker push abidhurais/helm-manifest-backend:latest

# ----------------------------------
# 9️⃣ Deploy Backend
# ----------------------------------
  deploy-backend:
    name: Deploy Backend
    runs-on: self-hosted
    needs: push-backend
    steps:
      - run: helm upgrade --install myapp helm/myapp -n devops-app
