name: CI/CD Pipeline

on:
  push:
    branches:
      - main

# =========================================================
# 1ï¸âƒ£ CHANGE DETECTION
# =========================================================
jobs:
  detect-changes:
    runs-on: self-hosted
    outputs:
      frontend: ${{ steps.detect.outputs.frontend }}
      backend: ${{ steps.detect.outputs.backend }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: detect
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED"

          if echo "$CHANGED" | grep -q "^frontend/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED" | grep -q "^backend/"; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

# =========================================================
# 2ï¸âƒ£ FRONTEND PIPELINE (STATIC HTML + NGINX)
# =========================================================
  frontend:
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ğŸ” SonarQube Scan (Docker â€“ Java 17 safe)
      - name: SonarQube Scan - Frontend
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          docker run --rm \
            -e SONAR_HOST_URL=$SONAR_HOST_URL \
            -e SONAR_LOGIN=$SONAR_TOKEN \
            -v "$PWD/frontend:/usr/src" \
            sonarsource/sonar-scanner-cli:latest \
            -Dsonar.projectKey=frontend \
            -Dsonar.sources=. \
            -Dsonar.sourceEncoding=UTF-8

      # ğŸ³ Build Docker Image (NGINX)
      - name: Build Frontend Image
        id: build
        run: |
          VERSION=$(date +%Y.%m.%d.%H%M%S)
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
          docker build -t abidhurais/helm-manifest:$VERSION frontend

      # ğŸ” Trivy Scan
      - name: Trivy Scan - Frontend
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            abidhurais/helm-manifest:${{ steps.build.outputs.tag }}

      # ğŸ“¤ Push Image
      - name: Push Frontend Image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          docker push abidhurais/helm-manifest:${{ steps.build.outputs.tag }}

      # ğŸ“ Update Helm values.yaml
      - name: Update Helm Tag (Frontend)
        run: |
          sed -i "s|tag: \".*\"|tag: \"${{ steps.build.outputs.tag }}\"|" helm/myapp/values.yaml

      # ğŸš€ Deploy via Helm
      - name: Deploy Frontend
        run: |
          helm upgrade --install myapp helm/myapp -n devops-app

# =========================================================
# 3ï¸âƒ£ BACKEND PIPELINE (NODE.JS + REDIS)
# =========================================================
  backend:
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Backend Dependencies
        run: |
          cd backend
          npm install --omit=dev

      # ğŸ” SonarQube Scan (Docker â€“ Java 17 safe)
      - name: SonarQube Scan - Backend
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          docker run --rm \
            -e SONAR_HOST_URL=$SONAR_HOST_URL \
            -e SONAR_LOGIN=$SONAR_TOKEN \
            -v "$PWD/backend:/usr/src" \
            sonarsource/sonar-scanner-cli:latest \
            -Dsonar.projectKey=backend \
            -Dsonar.sources=. \
            -Dsonar.sourceEncoding=UTF-8

      # ğŸ³ Build Docker Image
      - name: Build Backend Image
        id: build
        run: |
          VERSION=$(date +%Y.%m.%d.%H%M%S)
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
          docker build -t abidhurais/helm-manifest:$VERSION backend

      # ğŸ” Trivy Scan
      - name: Trivy Scan - Backend
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            abidhurais/helm-manifest:${{ steps.build.outputs.tag }}

      # ğŸ“¤ Push Image
      - name: Push Backend Image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          docker push abidhurais/helm-manifest:${{ steps.build.outputs.tag }}

      # ğŸ“ Update Helm values.yaml
      - name: Update Helm Tag (Backend)
        run: |
          sed -i "s|tag: \".*\"|tag: \"${{ steps.build.outputs.tag }}\"|" helm/myapp/values.yaml

      # ğŸš€ Deploy via Helm
      - name: Deploy Backend
        run: |
          helm upgrade --install myapp helm/myapp -n devops-app
