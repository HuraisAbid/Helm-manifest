name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
# ----------------------------------
# 1ï¸âƒ£ Detect Changes
# ----------------------------------
  detect-changes:
    runs-on: self-hosted
    outputs:
      frontend: ${{ steps.frontend.outputs.changed }}
      backend: ${{ steps.backend.outputs.changed }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - id: frontend
        run: |
          git diff --name-only HEAD~1 HEAD | grep '^frontend/' \
            && echo "changed=true" >> $GITHUB_OUTPUT \
            || echo "changed=false" >> $GITHUB_OUTPUT
      - id: backend
        run: |
          git diff --name-only HEAD~1 HEAD | grep '^backend/' \
            && echo "changed=true" >> $GITHUB_OUTPUT \
            || echo "changed=false" >> $GITHUB_OUTPUT

# ----------------------------------
# 2ï¸âƒ£ Frontend Pipeline (STATIC)
# ----------------------------------
  frontend:
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    steps:
      - uses: actions/checkout@v3

      # ðŸ”¥ NO npm install (STATIC SITE)
      - name: SonarQube Scan - Frontend
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          docker run --rm \
            -e SONAR_HOST_URL=$SONAR_HOST_URL \
            -e SONAR_TOKEN=$SONAR_TOKEN \
            -v "$PWD/frontend:/usr/src" \
            sonarsource/sonar-scanner-cli:latest \
            -Dsonar.projectKey=frontend \
            -Dsonar.sources=. \
            -Dsonar.sourceEncoding=UTF-8
      - name: Build Frontend Image
        id: fe-build
        run: |
          # ----------------------------
          # Incremental numeric tag (2 digits)
          # ----------------------------
          LAST_TAG=$(docker images abidhurais/helm-manifest-frontend --format "{{.Tag}}" | sort -n | tail -1)
          if [ -z "$LAST_TAG" ]; then
            VERSION=1
          else
            VERSION=$((LAST_TAG + 1))
          fi
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
          docker build -t abidhurais/helm-manifest-frontend:$VERSION frontend
      - name: Push Frontend Image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          docker push abidhurais/helm-manifest-frontend:${{ steps.fe-build.outputs.tag }}
      - name: Deploy Frontend
        run: |
          sed -i "s/frontendTag:.*/frontendTag: \"${{ steps.fe-build.outputs.tag }}\"/" helm/myapp/values.yaml
          helm upgrade --install myapp helm/myapp -n devops-app

# ----------------------------------
# 3ï¸âƒ£ Backend Pipeline (Node.js)
# ----------------------------------
  backend:
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Backend Deps
        run: |
          cd backend
          npm install
      - name: SonarQube Scan - Backend
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          docker run --rm \
            -e SONAR_HOST_URL=$SONAR_HOST_URL \
            -e SONAR_TOKEN=$SONAR_TOKEN \
            -v "$PWD/backend:/usr/src" \
            sonarsource/sonar-scanner-cli:latest \
            -Dsonar.projectKey=backend \
            -Dsonar.sources=. \
            -Dsonar.sourceEncoding=UTF-8
      - name: Build Backend Image
        id: be-build
        run: |
          # ----------------------------
          # Incremental numeric tag (2 digits)
          # ----------------------------
          LAST_TAG=$(docker images abidhurais/helm-manifest-backend --format "{{.Tag}}" | sort -n | tail -1)
          if [ -z "$LAST_TAG" ]; then
            VERSION=1
          else
            VERSION=$((LAST_TAG + 1))
          fi
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
          docker build -t abidhurais/helm-manifest-backend:$VERSION backend
      - name: Push Backend Image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          docker push abidhurais/helm-manifest-backend:${{ steps.be-build.outputs.tag }}
      - name: Deploy Backend
        run: |
          sed -i "s/backendTag:.*/backendTag: \"${{ steps.be-build.outputs.tag }}\"/" helm/myapp/values.yaml
          helm upgrade --install myapp helm/myapp -n devops-app
